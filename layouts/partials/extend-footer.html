<script src="https://getinsights.io/js/insights.js"></script>
<script>
  let id = '{{ os.Getenv "HUGO_INSIGHTS" }}';
  let doNotTrack = localStorage.getItem("insights") === 'do-not-track'
  if (id && !doNotTrack) {
    insights.init(id);
    insights.trackPages();
  }

  document.addEventListener("DOMContentLoaded", attachRandomLink);
  function attachRandomLink() {
    let rnd = [...document.querySelectorAll("nav li > a")].filter(a => a.innerText == "Random")[0]
    if (rnd) rnd.addEventListener("click", sendToRandomArticle)
  }

  function sendToRandomArticle(e) {
    e.preventDefault();
    fetch(window.location.origin + '/index.json')
      .then(r => r.json())
      .then(redirectAtRandom)
      .catch(err => console.log(err));
  }

  function redirectAtRandom(data) {
    let randIndex = Math.floor(Math.random() * data.length);
    if (!doNotTrack) insights.track({ id: "random-button" })
    window.location.href = data[randIndex]['permalink']
  }
</script>
